<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For Jess - Happy Valentine's Day</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, sans-serif; }
        #webgl-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        #css2d-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2; pointer-events: none; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center; z-index: 10;
            background: #000000; transition: opacity 1.5s ease; 
        }
        
        button {
            padding: 20px 40px; font-size: 24px; font-weight: bold; background-color: #e63946;
            color: white; border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(230, 57, 70, 0.4); transition: transform 0.2s; pointer-events: auto;
        }
        button:hover { transform: scale(1.05); }

        .map-label {
            color: white; font-weight: bold; padding: 5px 10px; border-radius: 5px;
            font-size: 14px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); pointer-events: none;
            white-space: nowrap;
        }
        .label-start { background: rgba(255, 215, 0, 0.5); border: 2px solid gold; color: gold; }
        .label-end { background: rgba(255, 105, 180, 0.5); border: 2px solid hotpink; color: hotpink; }
        
        #instructions {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            color: white; font-size: 18px; display: none; z-index: 5; pointer-events: none;
            text-shadow: 1px 1px 2px black;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/",
                "gsap": "https://unpkg.com/gsap@3.12.2/index.js"
            }
        }
    </script>
</head>
<body>
    
    <video id="tvVideo" src="video.mp4" playsinline style="display:none;"></video>
    <audio id="tvAudio" src="song.mp3" preload="auto"></audio>

    <div id="ui-layer">
        <button id="startBtn">Enter Our World</button>
    </div>
    <div id="instructions">Click the right side of the book to turn pages</div>
    
    <div id="webgl-container"></div>
    <div id="css2d-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';
        import gsap from 'gsap';

        // --- GLOBAL SETUP ---
        const container = document.getElementById('webgl-container');
        const cssContainer = document.getElementById('css2d-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); 
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 4.5, 7); 

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
        cssContainer.appendChild(labelRenderer.domElement);

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
        dirLight.position.set(2, 8, 5);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- SCENE 1: THE 3D SIMPSONS ROOM ---
        const roomGroup = new THREE.Group();
        scene.add(roomGroup);

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), new THREE.MeshStandardMaterial({ color: 0x1da289 }));
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        roomGroup.add(floor);

        const wallMat = new THREE.MeshStandardMaterial({ color: 0xff91af }); 
        const backWall = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), wallMat);
        backWall.position.set(0, 7.5, -8);
        backWall.receiveShadow = true;
        roomGroup.add(backWall);

        const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), wallMat);
        leftWall.rotation.y = Math.PI / 2;
        leftWall.position.set(-12, 7.5, 0);
        leftWall.receiveShadow = true;
        roomGroup.add(leftWall);

        const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), wallMat);
        rightWall.rotation.y = -Math.PI / 2;
        rightWall.position.set(12, 7.5, 0);
        rightWall.receiveShadow = true;
        roomGroup.add(rightWall);

        const rug = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 0.05, 32), new THREE.MeshStandardMaterial({ color: 0xc964af }));
        rug.scale.set(1, 1, 0.6); 
        rug.position.set(0, 0.02, -1);
        roomGroup.add(rug);

        const couchMat = new THREE.MeshStandardMaterial({ color: 0xd2691e });
        const couchSeat = new THREE.Mesh(new THREE.BoxGeometry(6, 1, 2.5), couchMat);
        couchSeat.position.set(0, 0.5, 2.5);
        couchSeat.castShadow = true;
        const couchBack = new THREE.Mesh(new THREE.BoxGeometry(6, 2, 0.5), couchMat);
        couchBack.position.set(0, 2, 3.5);
        couchBack.castShadow = true;
        roomGroup.add(couchSeat, couchBack);

        const table = new THREE.Mesh(new THREE.BoxGeometry(3, 1, 1.5), new THREE.MeshStandardMaterial({ color: 0xcd853f }));
        table.position.set(0, 0.5, -1.5);
        table.castShadow = true;
        roomGroup.add(table);

        const tvStand = new THREE.Mesh(new THREE.BoxGeometry(4, 1.5, 2), new THREE.MeshStandardMaterial({ color: 0x784c98 }));
        tvStand.position.set(0, 0.75, -5.5);
        tvStand.castShadow = true;
        roomGroup.add(tvStand);

        const tvBox = new THREE.Mesh(new THREE.BoxGeometry(3.5, 2.5, 1.5), new THREE.MeshStandardMaterial({ color: 0x8a929e }));
        tvBox.position.set(0, 2.75, -5.5);
        tvBox.castShadow = true;
        roomGroup.add(tvBox);

        const lampBase = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.2, 4), new THREE.MeshStandardMaterial({ color: 0x8a2be2 }));
        lampBase.position.set(-4.5, 2, -6);
        const lampShade = new THREE.Mesh(new THREE.ConeGeometry(0.8, 1, 16), new THREE.MeshStandardMaterial({ color: 0xff4500 }));
        lampShade.position.set(-4.5, 4.5, -6);
        roomGroup.add(lampBase, lampShade);

        const frame = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 0.1), new THREE.MeshStandardMaterial({ color: 0xcd853f }));
        frame.position.set(0, 6, -7.9);
        const picture = new THREE.Mesh(new THREE.PlaneGeometry(1.8, 1.3), new THREE.MeshBasicMaterial({ color: 0x87ceeb }));
        picture.position.set(0, 6, -7.84);
        roomGroup.add(frame, picture);

        const remoteGroup = new THREE.Group();
        const remoteBody = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.05, 0.6), new THREE.MeshStandardMaterial({ color: 0x222222 }));
        const remoteBtn = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.03, 0.08), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
        remoteBtn.position.set(0, 0.03, -0.2); 
        remoteGroup.add(remoteBody, remoteBtn);
        remoteGroup.position.set(0.5, 1.02, -1.5); 
        roomGroup.add(remoteGroup);

        const flickerCanvas = document.createElement('canvas');
        flickerCanvas.width = 512; flickerCanvas.height = 256;
        const flickerCtx = flickerCanvas.getContext('2d');
        const flickerTexture = new THREE.CanvasTexture(flickerCanvas);
        flickerCtx.fillStyle = '#111111';
        flickerCtx.fillRect(0, 0, 512, 256);

        const videoEl = document.getElementById('tvVideo');
        const audioEl = document.getElementById('tvAudio'); // Hooking up the audio!
        const videoTexture = new THREE.VideoTexture(videoEl);

        const tvScreen = new THREE.Mesh(new THREE.PlaneGeometry(3.2, 2.2), new THREE.MeshBasicMaterial({ map: flickerTexture }));
        tvScreen.position.set(0, 2.75, -4.74); 
        roomGroup.add(tvScreen);

        // --- SCENE 2: THE 3D CITY MAP ---
        const mapGroup = new THREE.Group();
        mapGroup.visible = false;
        scene.add(mapGroup);

        const mapFloor = new THREE.Mesh(new THREE.PlaneGeometry(80, 80), new THREE.MeshStandardMaterial({ color: 0x111111 }));
        mapFloor.rotation.x = -Math.PI / 2;
        mapFloor.receiveShadow = true;
        mapGroup.add(mapFloor);

        const cityGroup = new THREE.Group();
        const buildingGeo = new THREE.BoxGeometry(1, 1, 1);
        const buildingMat = new THREE.MeshStandardMaterial({ color: 0x2a3b4c, roughness: 0.8 });

        for (let i = 0; i < 300; i++) {
            const building = new THREE.Mesh(buildingGeo, buildingMat);
            building.castShadow = true;
            building.receiveShadow = true;
            const x = (Math.random() - 0.5) * 50;
            const z = (Math.random() - 0.5) * 50;
            const height = Math.random() * 8 + 1;
            building.scale.set(1 + Math.random(), height, 1 + Math.random());
            building.position.set(x, height / 2, z);
            if (Math.abs(x - z) > 5) cityGroup.add(building);
        }
        mapGroup.add(cityGroup);

        const startPos = new THREE.Vector3(-12, 0.5, -12);
        const endPos = new THREE.Vector3(14, 0.5, 14);

        const startMarker = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({ color: 0xffd700 }));
        startMarker.position.copy(startPos);
        mapGroup.add(startMarker);
        const startDiv = document.createElement('div'); startDiv.className = 'map-label label-start'; startDiv.textContent = '10996 Rametsane';
        startMarker.add(new CSS2DObject(startDiv));

        const endMarker = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({ color: 0xff69b4 }));
        endMarker.position.copy(endPos);
        mapGroup.add(endMarker);
        const endDiv = document.createElement('div'); endDiv.className = 'map-label label-end'; endDiv.textContent = '59866 Shorobe St, Block 7';
        endMarker.add(new CSS2DObject(endDiv));

        const routeCurve = new THREE.CatmullRomCurve3([
            startPos, new THREE.Vector3(-6, 0.5, -4), new THREE.Vector3(2, 0.5, 0), new THREE.Vector3(8, 0.5, 6), endPos
        ]);
        const routeLine = new THREE.Line(
            new THREE.BufferGeometry().setFromPoints(routeCurve.getPoints(150)),
            new THREE.LineDashedMaterial({ color: 0xffffff, dashSize: 1, gapSize: 0.5, linewidth: 3 })
        );
        routeLine.computeLineDistances();
        mapGroup.add(routeLine);

        const car = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.6, 2.0), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
        car.castShadow = true;
        mapGroup.add(car);

        // --- SCENE 3: THE HEART PARTICLE RAIN ---
        const heartCanvas = document.createElement('canvas');
        heartCanvas.width = 64; heartCanvas.height = 64;
        const hCtx = heartCanvas.getContext('2d');
        hCtx.fillStyle = '#ffffff'; 
        hCtx.beginPath();
        hCtx.moveTo(32, 15);
        hCtx.bezierCurveTo(32, 12, 25, 0, 15, 0);
        hCtx.bezierCurveTo(0, 0, 0, 17.5, 0, 17.5);
        hCtx.bezierCurveTo(0, 30, 20, 42, 32, 55);
        hCtx.bezierCurveTo(44, 42, 64, 30, 64, 17.5);
        hCtx.bezierCurveTo(64, 17.5, 64, 0, 49, 0);
        hCtx.bezierCurveTo(39, 0, 32, 12, 32, 15);
        hCtx.fill();
        const heartTexture = new THREE.CanvasTexture(heartCanvas);

        const particleCount = 200;
        const particlesGeo = new THREE.BufferGeometry();
        const posArray = new Float32Array(particleCount * 3);
        const colArray = new Float32Array(particleCount * 3);
        const colorsOfLove = [new THREE.Color(0xff4d4d), new THREE.Color(0xffb3b3), new THREE.Color(0xff1a1a), new THREE.Color(0xffccd5)];

        for(let i=0; i < particleCount; i++) {
            posArray[i*3] = (Math.random() - 0.5) * 20; 
            posArray[i*3+1] = Math.random() * 20 - 5;   
            posArray[i*3+2] = (Math.random() - 0.5) * 10 - 2; 
            
            const c = colorsOfLove[Math.floor(Math.random() * colorsOfLove.length)];
            colArray[i*3] = c.r; colArray[i*3+1] = c.g; colArray[i*3+2] = c.b;
        }

        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particlesGeo.setAttribute('color', new THREE.BufferAttribute(colArray, 3));

        const particleMat = new THREE.PointsMaterial({
            size: 0.8, map: heartTexture, transparent: true, opacity: 0.8, vertexColors: true, depthWrite: false
        });

        const heartParticles = new THREE.Points(particlesGeo, particleMat);
        heartParticles.visible = false; 
        scene.add(heartParticles);

        // --- SCENE 4: THE REALISTIC 10-PAGE BOOK ---
        const bookGroup = new THREE.Group();
        bookGroup.visible = false;
        scene.add(bookGroup);
        
        const pages = [];

        function drawHeart(ctx, x, y, width, height) {
            ctx.save();
            ctx.beginPath();
            const topCurveHeight = height * 0.3;
            ctx.moveTo(x, y + topCurveHeight);
            ctx.bezierCurveTo(x, y, x - width / 2, y, x - width / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x - width / 2, y + (height + topCurveHeight) / 2, x, y + (height + topCurveHeight) / 2, x, y + height);
            ctx.bezierCurveTo(x, y + (height + topCurveHeight) / 2, x + width / 2, y + (height + topCurveHeight) / 2, x + width / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x + width / 2, y, x, y, x, y + topCurveHeight);
            ctx.closePath();
            ctx.fillStyle = "rgba(255, 77, 77, 0.6)";
            ctx.fill();
            ctx.restore();
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            for(let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, y);
        }

        function createPageTexture(pageNum, title, text) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#fdf6e3'; 
            ctx.fillRect(0, 0, 512, 1024); 

            const spineGradient = ctx.createLinearGradient(0, 0, 50, 0);
            spineGradient.addColorStop(0, 'rgba(0,0,0,0.15)');
            spineGradient.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = spineGradient;
            ctx.fillRect(0, 0, 50, 1024);

            drawHeart(ctx, 256, 850, 60, 60);
            if(pageNum === 1) drawHeart(ctx, 256, 150, 100, 100);

            ctx.fillStyle = '#3a2b25'; 
            
            if(pageNum === 1) {
                 ctx.font = 'bold 60px "Georgia", serif'; ctx.textAlign = 'center';
                 ctx.fillText("Our Story", 256, 400);
                 ctx.font = 'italic 35px "Georgia", serif';
                 ctx.fillText("For my beautiful Jess", 256, 500);
                 ctx.fillText("Happy Valentine's Day", 256, 580);
            } else {
                ctx.font = 'bold 35px "Georgia", serif'; ctx.textAlign = 'center';
                ctx.fillText(title, 256, 120);
                ctx.font = 'italic 28px "Georgia", serif';
                ctx.textAlign = 'left';
                wrapText(ctx, text, 60, 250, 400, 45); 
            }
            return new THREE.CanvasTexture(canvas);
        }

        const bookChapters = [
            { title: "", text: "" }, 
            { title: "Chapter 1: The Beginning", text: "From the very first moment I saw you, I knew my life was about to change. There was a light in your eyes that drew me in, and a warmth in your smile that felt instantly like coming home." },
            { title: "Chapter 2: The Little Things", text: "Every single day we spend together, I discover something new to love about you. You have this incredible, effortless ability to make the world around you so much brighter." },
            { title: "Chapter 3: Through My Eyes", text: "I know that sometimes you might doubt yourself, or wonder if you are enough. But I want you to look at yourself the way I see you. You are brilliant, you are resilient, and you are absolutely breathtaking." },
            { title: "Chapter 4: My Safe Place", text: "Whether we are laughing until we can't breathe, exploring the city together, or just sitting in quiet comfort, there is nowhere else I would rather be. You are my safe place, Jess." },
            { title: "Chapter 5: Your Heart", text: "I love the way your mind works. I love your passion, your immense kindness, and the gentle, caring way you treat the people around you. You have a heart of absolute gold." },
            { title: "Chapter 6: My Promise", text: "I promise to always be your biggest cheerleader. On the days when you feel on top of the world, I will be right there celebrating. And on the days when things feel heavy, I will hold your hand through the storm." },
            { title: "Chapter 7: Your Worth", text: "You are the most beautiful part of my life, both inside and out. Please never forget your worth, Jess. You are a masterpiece, and I am the luckiest person in the world to call you mine." },
            { title: "Chapter 8: Our Future", text: "As we keep driving forward, building our future together step by step, I want you to know that my love for you only grows deeper. I am so incredibly excited for every tomorrow I get to spend with you." },
            { title: "Chapter 9: Forever", text: "Thank you for being exactly who you are. Thank you for letting me love you, and for loving me back. Jess, never forget how incredibly special you are. You mean a lot to me. Happy Valentine's Day, my love." }
        ];

        for(let i = 0; i < 10; i++) {
            const pivot = new THREE.Group();
            pivot.position.set(-1.5, 0, (10 - i) * 0.01); 
            const pageMat = new THREE.MeshStandardMaterial({ 
                map: createPageTexture(i+1, bookChapters[i].title, bookChapters[i].text), 
                side: THREE.DoubleSide, roughness: 0.9, metalness: 0.1
            });
            const pageMesh = new THREE.Mesh(new THREE.BoxGeometry(3, 4, 0.015), pageMat);
            pageMesh.position.set(1.5, 0, 0); 
            pageMesh.userData = { id: i, flipped: false };
            pivot.add(pageMesh);
            bookGroup.add(pivot);
            pages.push({ pivot: pivot, mesh: pageMesh });
        }
        
        const backCover = new THREE.Mesh(
            new THREE.BoxGeometry(3.2, 4.2, 0.05), 
            new THREE.MeshStandardMaterial({ color: 0x5a0000, roughness: 1.0 })
        );
        backCover.position.set(0,0,-0.1);
        bookGroup.add(backCover);

        // --- THE CINEMATIC ANIMATION SEQUENCE ---

        let appState = 'room'; 
        let mapProgress = 0;
        let flickerInterval;

        document.getElementById('startBtn').addEventListener('click', () => {
            const uiLayer = document.getElementById('ui-layer');
            uiLayer.style.opacity = 0;
            setTimeout(() => uiLayer.remove(), 1500); 
            
            // This initializes audio on mobile devices so it isn't blocked later
            audioEl.play().catch(()=>{});
            audioEl.pause();
            audioEl.currentTime = 0;

            const tl = gsap.timeline();

            tl.to(camera.position, { z: 2.5, y: 2.5, duration: 2, ease: "power2.inOut" }, 0);
            tl.to(remoteGroup.position, { x: 0.5, y: 1.8, z: 1.5, duration: 1, ease: "back.in(1)" }, 1.5);
            tl.to(remoteGroup.rotation, { x: 0.5 }, 1.5);
            tl.to(remoteGroup.scale, { x:0, y:0, z:0, duration: 0.2 }, 2.5);

            tl.call(() => {
                let flickerCount = 0;
                flickerInterval = setInterval(() => {
                    flickerCtx.fillStyle = Math.random() > 0.5 ? '#ffffff' : '#333333';
                    flickerCtx.fillRect(0,0,512,256);
                    flickerTexture.needsUpdate = true;
                    flickerCount++;
                    
                    if(flickerCount > 15) { 
                        clearInterval(flickerInterval);
                        
                        // PLAY VIDEO AND AUDIO TOGETHER!
                        tvScreen.material.map = videoTexture;
                        tvScreen.material.needsUpdate = true;
                        videoEl.play();
                        audioEl.play();
                        
                        // Wait for the video compilation to finish before transitioning
                        videoEl.addEventListener('ended', () => {
                             startZoomSequence();
                        });
                        
                        // Safety backup timer in case the browser blocks the 'ended' event
                        setTimeout(() => {
                            if(appState === 'room') startZoomSequence();
                        }, 60000); // Set to 60 seconds as a backup
                    }
                }, 100);
            }, null, 2.7);
        });

        function startZoomSequence() {
            gsap.to(camera.position, {
                x: 0, y: 2.75, z: -3.8, 
                duration: 2.5,
                ease: "power3.inOut",
                onComplete: () => {
                    roomGroup.visible = false;
                    mapGroup.visible = true;
                    appState = 'map';
                    camera.position.set(-15, 25, 25); 
                    camera.lookAt(0, 0, 0);
                }
            });
        }

        window.addEventListener('pointerdown', (e) => {
            if(appState !== 'book') return;
            mouse.x
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For Jess - Happy Valentine's Day</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, sans-serif; }
        #webgl-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        #css2d-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2; pointer-events: none; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center; z-index: 10;
            background: #000000; transition: opacity 1.5s ease; 
        }
        
        button {
            padding: 20px 40px; font-size: 24px; font-weight: bold; background-color: #e63946;
            color: white; border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(230, 57, 70, 0.4); transition: transform 0.2s; pointer-events: auto;
        }
        button:hover { transform: scale(1.05); }

        .map-label {
            color: white; font-weight: bold; padding: 5px 10px; border-radius: 5px;
            font-size: 14px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); pointer-events: none;
            white-space: nowrap;
        }
        .label-start { background: rgba(255, 215, 0, 0.5); border: 2px solid gold; color: gold; }
        .label-end { background: rgba(255, 105, 180, 0.5); border: 2px solid hotpink; color: hotpink; }
        
        #instructions {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            color: white; font-size: 18px; display: none; z-index: 5; pointer-events: none;
            text-shadow: 1px 1px 2px black;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/",
                "gsap": "https://unpkg.com/gsap@3.12.2/index.js"
            }
        }
    </script>
</head>
<body>
    
    <video id="tvVideo" src="video.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" style="display:none;"></video>
    <audio id="tvAudio" src="song.mp3" crossorigin="anonymous" loop></audio>

    <div id="ui-layer">
        <button id="startBtn">Enter Our World</button>
    </div>
    <div id="instructions">Click the right side of the book to turn pages</div>
    
    <div id="webgl-container"></div>
    <div id="css2d-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';
        import gsap from 'gsap';

        const container = document.getElementById('webgl-container');
        const cssContainer = document.getElementById('css2d-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); 
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 4.5, 7); 

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
        cssContainer.appendChild(labelRenderer.domElement);

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
        dirLight.position.set(2, 8, 5);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- SCENE 1: THE 3D SIMPSONS ROOM ---
        const roomGroup = new THREE.Group();
        scene.add(roomGroup);

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), new THREE.MeshStandardMaterial({ color: 0x1da289 }));
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        roomGroup.add(floor);

        const wallMat = new THREE.MeshStandardMaterial({ color: 0xff91af }); 
        const backWall = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), wallMat);
        backWall.position.set(0, 7.5, -8);
        backWall.receiveShadow = true;
        roomGroup.add(backWall);

        const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), wallMat);
        leftWall.rotation.y = Math.PI / 2;
        leftWall.position.set(-12, 7.5, 0);
        leftWall.receiveShadow = true;
        roomGroup.add(leftWall);

        const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), wallMat);
        rightWall.rotation.y = -Math.PI / 2;
        rightWall.position.set(12, 7.5, 0);
        rightWall.receiveShadow = true;
        roomGroup.add(rightWall);

        const rug = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 0.05, 32), new THREE.MeshStandardMaterial({ color: 0xc964af }));
        rug.scale.set(1, 1, 0.6); 
        rug.position.set(0, 0.02, -1);
        roomGroup.add(rug);

        const couchMat = new THREE.MeshStandardMaterial({ color: 0xd2691e });
        const couchSeat = new THREE.Mesh(new THREE.BoxGeometry(6, 1, 2.5), couchMat);
        couchSeat.position.set(0, 0.5, 2.5);
        couchSeat.castShadow = true;
        const couchBack = new THREE.Mesh(new THREE.BoxGeometry(6, 2, 0.5), couchMat);
        couchBack.position.set(0, 2, 3.5);
        couchBack.castShadow = true;
        roomGroup.add(couchSeat, couchBack);

        const table = new THREE.Mesh(new THREE.BoxGeometry(3, 1, 1.5), new THREE.MeshStandardMaterial({ color: 0xcd853f }));
        table.position.set(0, 0.5, -1.5);
        table.castShadow = true;
        roomGroup.add(table);

        const tvStand = new THREE.Mesh(new THREE.BoxGeometry(4, 1.5, 2), new THREE.MeshStandardMaterial({ color: 0x784c98 }));
        tvStand.position.set(0, 0.75, -5.5);
        tvStand.castShadow = true;
        roomGroup.add(tvStand);

        const tvBox = new THREE.Mesh(new THREE.BoxGeometry(3.5, 2.5, 1.5), new THREE.MeshStandardMaterial({ color: 0x8a929e }));
        tvBox.position.set(0, 2.75, -5.5);
        tvBox.castShadow = true;
        roomGroup.add(tvBox);

        const lampBase = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.2, 4), new THREE.MeshStandardMaterial({ color: 0x8a2be2 }));
        lampBase.position.set(-4.5, 2, -6);
        const lampShade = new THREE.Mesh(new THREE.ConeGeometry(0.8, 1, 16), new THREE.MeshStandardMaterial({ color: 0xff4500 }));
        lampShade.position.set(-4.5, 4.5, -6);
        roomGroup.add(lampBase, lampShade);

        const frame = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 0.1), new THREE.MeshStandardMaterial({ color: 0xcd853f }));
        frame.position.set(0, 6, -7.9);
        const picture = new THREE.Mesh(new THREE.PlaneGeometry(1.8, 1.3), new THREE.MeshBasicMaterial({ color: 0x87ceeb }));
        picture.position.set(0, 6, -7.84);
        roomGroup.add(frame, picture);

        const remoteGroup = new THREE.Group();
        const remoteBody = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.05, 0.6), new THREE.MeshStandardMaterial({ color: 0x222222 }));
        const remoteBtn = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.03, 0.08), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
        remoteBtn.position.set(0, 0.03, -0.2); 
        remoteGroup.add(remoteBody, remoteBtn);
        remoteGroup.position.set(0.5, 1.02, -1.5); 
        roomGroup.add(remoteGroup);

        const flickerCanvas = document.createElement('canvas');
        flickerCanvas.width = 512; flickerCanvas.height = 256;
        const flickerCtx = flickerCanvas.getContext('2d');
        const flickerTexture = new THREE.CanvasTexture(flickerCanvas);
        flickerCtx.fillStyle = '#111111';
        flickerCtx.fillRect(0, 0, 512, 256);

        const videoEl = document.getElementById('tvVideo');
        const audioEl = document.getElementById('tvAudio');
        const videoTexture = new THREE.VideoTexture(videoEl);

        const tvScreen = new THREE.Mesh(new THREE.PlaneGeometry(3.2, 2.2), new THREE.MeshBasicMaterial({ map: flickerTexture }));
        tvScreen.position.set(0, 2.75, -4.74); 
        roomGroup.add(tvScreen);

        // --- SCENE 2: THE 3D CITY MAP ---
        const mapGroup = new THREE.Group();
        mapGroup.visible = false;
        scene.add(mapGroup);

        const mapFloor = new THREE.Mesh(new THREE.PlaneGeometry(80, 80), new THREE.MeshStandardMaterial({ color: 0x111111 }));
        mapFloor.rotation.x = -Math.PI / 2;
        mapFloor.receiveShadow = true;
        mapGroup.add(mapFloor);

        const cityGroup = new THREE.Group();
        const buildingGeo = new THREE.BoxGeometry(1, 1, 1);
        const buildingMat = new THREE.MeshStandardMaterial({ color: 0x2a3b4c, roughness: 0.8 });

        for (let i = 0; i < 300; i++) {
            const building = new THREE.Mesh(buildingGeo, buildingMat);
            building.castShadow = true;
            building.receiveShadow = true;
            const x = (Math.random() - 0.5) * 50;
            const z = (Math.random() - 0.5) * 50;
            const height = Math.random() * 8 + 1;
            building.scale.set(1 + Math.random(), height, 1 + Math.random());
            building.position.set(x, height / 2, z);
            if (Math.abs(x - z) > 5) cityGroup.add(building);
        }
        mapGroup.add(cityGroup);

        const startPos = new THREE.Vector3(-12, 0.5, -12);
        const endPos = new THREE.Vector3(14, 0.5, 14);

        const startMarker = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({ color: 0xffd700 }));
        startMarker.position.copy(startPos);
        mapGroup.add(startMarker);
        const startDiv = document.createElement('div'); startDiv.className = 'map-label label-start'; startDiv.textContent = '10996 Rametsane';
        startMarker.add(new CSS2DObject(startDiv));

        const endMarker = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({ color: 0xff69b4 }));
        endMarker.position.copy(endPos);
        mapGroup.add(endMarker);
        const endDiv = document.createElement('div'); endDiv.className = 'map-label label-end'; endDiv.textContent = '59866 Shorobe St, Block 7';
        endMarker.add(new CSS2DObject(endDiv));

        const routeCurve = new THREE.CatmullRomCurve3([
            startPos, new THREE.Vector3(-6, 0.5, -4), new THREE.Vector3(2, 0.5, 0), new THREE.Vector3(8, 0.5, 6), endPos
        ]);
        const routeLine = new THREE.Line(
            new THREE.BufferGeometry().setFromPoints(routeCurve.getPoints(150)),
            new THREE.LineDashedMaterial({ color: 0xffffff, dashSize: 1, gapSize: 0.5, linewidth: 3 })
        );
        routeLine.computeLineDistances();
        mapGroup.add(routeLine);

        const car = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.6, 2.0), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
        car.castShadow = true;
        mapGroup.add(car);

        // --- SCENE 3: THE HEART PARTICLE RAIN ---
        const heartCanvas = document.createElement('canvas');
        heartCanvas.width = 64; heartCanvas.height = 64;
        const hCtx = heartCanvas.getContext('2d');
        hCtx.fillStyle = '#ffffff'; 
        hCtx.beginPath();
        hCtx.moveTo(32, 15);
        hCtx.bezierCurveTo(32, 12, 25, 0, 15, 0);
        hCtx.bezierCurveTo(0, 0, 0, 17.5, 0, 17.5);
        hCtx.bezierCurveTo(0, 30, 20, 42, 32, 55);
        hCtx.bezierCurveTo(44, 42, 64, 30, 64, 17.5);
        hCtx.bezierCurveTo(64, 17.5, 64, 0, 49, 0);
        hCtx.bezierCurveTo(39, 0, 32, 12, 32, 15);
        hCtx.fill();
        const heartTexture = new THREE.CanvasTexture(heartCanvas);

        const particleCount = 200;
        const particlesGeo = new THREE.BufferGeometry();
        const posArray = new Float32Array(particleCount * 3);
        const colArray = new Float32Array(particleCount * 3);
        const colorsOfLove = [new THREE.Color(0xff4d4d), new THREE.Color(0xffb3b3), new THREE.Color(0xff1a1a), new THREE.Color(0xffccd5)];

        for(let i=0; i < particleCount; i++) {
            posArray[i*3] = (Math.random() - 0.5) * 20; 
            posArray[i*3+1] = Math.random() * 20 - 5;   
            posArray[i*3+2] = (Math.random() - 0.5) * 10 - 2; 
            
            const c = colorsOfLove[Math.floor(Math.random() * colorsOfLove.length)];
            colArray[i*3] = c.r; colArray[i*3+1] = c.g; colArray[i*3+2] = c.b;
        }

        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particlesGeo.setAttribute('color', new THREE.BufferAttribute(colArray, 3));

        const particleMat = new THREE.PointsMaterial({
            size: 0.8, map: heartTexture, transparent: true, opacity: 0.8, vertexColors: true, depthWrite: false
        });

        const heartParticles = new THREE.Points(particlesGeo, particleMat);
        heartParticles.visible = false; 
        scene.add(heartParticles);

        // --- SCENE 4: THE REALISTIC 10-PAGE BOOK ---
        const bookGroup = new THREE.Group();
        bookGroup.visible = false;
        scene.add(bookGroup);
        
        const pages = [];

        function drawHeart(ctx, x, y, width, height) {
            ctx.save();
            ctx.beginPath();
            const topCurveHeight = height * 0.3;
            ctx.moveTo(x, y + topCurveHeight);
            ctx.bezierCurveTo(x, y, x - width / 2, y, x - width / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x - width / 2, y + (height + topCurveHeight) / 2, x, y + (height + topCurveHeight) / 2, x, y + height);
            ctx.bezierCurveTo(x, y + (height + topCurveHeight) / 2, x + width / 2, y + (height + topCurveHeight) / 2, x + width / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x + width / 2, y, x, y, x, y + topCurveHeight);
            ctx.closePath();
            ctx.fillStyle = "rgba(255, 77, 77, 0.6)";
            ctx.fill();
            ctx.restore();
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            for(let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, y);
        }

        function createPageTexture(pageNum, title, text) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#fdf6e3'; 
            ctx.fillRect(0, 0, 512, 1024); 

            const spineGradient = ctx.createLinearGradient(0, 0, 50, 0);
            spineGradient.addColorStop(0, 'rgba(0,0,0,0.15)');
            spineGradient.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = spineGradient;
            ctx.fillRect(0, 0, 50, 1024);

            drawHeart(ctx, 256, 850, 60, 60);
            if(pageNum === 1) drawHeart(ctx, 256, 150, 100, 100);

            ctx.fillStyle = '#3a2b25'; 
            
            if(pageNum === 1) {
                 ctx.font = 'bold 60px "Georgia", serif'; ctx.textAlign = 'center';
                 ctx.fillText("Our Story", 256, 400);
                 ctx.font = 'italic 35px "Georgia", serif';
                 ctx.fillText("For my beautiful Jess", 256, 500);
                 ctx.fillText("Happy Valentine's Day", 256, 580);
            } else {
                ctx.font = 'bold 35px "Georgia", serif'; ctx.textAlign = 'center';
                ctx.fillText(title, 256, 120);
                ctx.font = 'italic 28px "Georgia", serif';
                ctx.textAlign = 'left';
                wrapText(ctx, text, 60, 250, 400, 45); 
            }
            return new THREE.CanvasTexture(canvas);
        }

        const bookChapters = [
            { title: "", text: "" }, 
            { title: "Chapter 1: The Beginning", text: "From the very first moment I saw you, I knew my life was about to change. There was a light in your eyes that drew me in, and a warmth in your smile that felt instantly like coming home." },
            { title: "Chapter 2: The Little Things", text: "Every single day we spend together, I discover something new to love about you. You have this incredible, effortless ability to make the world around you so much brighter." },
            { title: "Chapter 3: Through My Eyes", text: "I know that sometimes you might doubt yourself, or wonder if you are enough. But I want you to look at yourself the way I see you. You are brilliant, you are resilient, and you are absolutely breathtaking." },
            { title: "Chapter 4: My Safe Place", text: "Whether we are laughing until we can't breathe, exploring the city together, or just sitting in quiet comfort, there is nowhere else I would rather be. You are my safe place, Jess." },
            { title: "Chapter 5: Your Heart", text: "I love the way your mind works. I love your passion, your immense kindness, and the gentle, caring way you treat the people around you. You have a heart of absolute gold." },
            { title: "Chapter 6: My Promise", text: "I promise to always be your biggest cheerleader. On the days when you feel on top of the world, I will be right there celebrating. And on the days when things feel heavy, I will hold your hand through the storm." },
            { title: "Chapter 7: Your Worth", text: "You are the most beautiful part of my life, both inside and out. Please never forget your worth, Jess. You are a masterpiece, and I am the luckiest person in the world to call you mine." },
            { title: "Chapter 8: Our Future", text: "As we keep driving forward, building our future together step by step, I want you to know that my love for you only grows deeper. I am so incredibly excited for every tomorrow I get to spend with you." },
            { title: "Chapter 9: Forever", text: "Thank you for being exactly who you are. Thank you for letting me love you, and for loving me back. Jess, never forget how incredibly special you are. You mean a lot to me. Happy Valentine's Day, my love." }
        ];

        for(let i = 0; i < 10; i++) {
            const pivot = new THREE.Group();
            pivot.position.set(-1.5, 0, (10 - i) * 0.01); 
            const pageMat = new THREE.MeshStandardMaterial({ 
                map: createPageTexture(i+1, bookChapters[i].title, bookChapters[i].text), 
                side: THREE.DoubleSide, roughness: 0.9, metalness: 0.1
            });
            const pageMesh = new THREE.Mesh(new THREE.BoxGeometry(3, 4, 0.015), pageMat);
            pageMesh.position.set(1.5, 0, 0); 
            pageMesh.userData = { id: i, flipped: false };
            pivot.add(pageMesh);
            bookGroup.add(pivot);
            pages.push({ pivot: pivot, mesh: pageMesh });
        }
        
        const backCover = new THREE.Mesh(
            new THREE.BoxGeometry(3.2, 4.2, 0.05), 
            new THREE.MeshStandardMaterial({ color: 0x5a0000, roughness: 1.0 })
        );
        backCover.position.set(0,0,-0.1);
        bookGroup.add(backCover);

        // --- THE CINEMATIC ANIMATION SEQUENCE ---

        let appState = 'room'; 
        let mapProgress = 0;
        let flickerInterval;

        document.getElementById('startBtn').addEventListener('click', () => {
            
            // 1. THIS IS THE FIX: UNLOCK MEDIA IMMEDIATELY ON CLICK
            videoEl.play().then(() => { videoEl.pause(); videoEl.currentTime = 0; }).catch(e => console.log("Video wait"));
            audioEl.play().then(() => { audioEl.pause(); audioEl.currentTime = 0; }).catch(e => console.log("Audio wait"));

            const uiLayer = document.getElementById('ui-layer');
            uiLayer.style.opacity = 0;
            setTimeout(() => uiLayer.remove(), 1500); 

            const tl = gsap.timeline();

            tl.to(camera.position, { z: 2.5, y: 2.5, duration: 2, ease: "power2.inOut" }, 0);
            tl.to(remoteGroup.position, { x: 0.5, y: 1.8, z: 1.5, duration: 1, ease: "back.in(1)" }, 1.5);
            tl.to(remoteGroup.rotation, { x: 0.5 }, 1.5);
            tl.to(remoteGroup.scale, { x:0, y:0, z:0, duration: 0.2 }, 2.5);

            tl.call(() => {
                let flickerCount = 0;
                flickerInterval = setInterval(() => {
                    flickerCtx.fillStyle = Math.random() > 0.5 ? '#ffffff' : '#333333';
                    flickerCtx.fillRect(0,0,512,256);
                    flickerTexture.needsUpdate = true;
                    flickerCount++;
                    
                    if(flickerCount > 15) { 
                        clearInterval(flickerInterval);
                        
                        // PLAY VIDEO AND SONG AT THE EXACT SAME TIME
                        tvScreen.material.map = videoTexture;
                        tvScreen.material.needsUpdate = true;
                        
                        videoEl.play().catch(e => console.log(e));
                        audioEl.play().catch(e => console.log(e));
                        
                        // Let her watch the TV memories for 15 seconds, 
                        // then zoom into the map while the song keeps playing!
                        setTimeout(startZoomSequence, 15000); 
                    }
                }, 100);
            }, null, 2.7);
        });

        function startZoomSequence() {
            gsap.to(camera.position, {
                x: 0, y: 2.75, z: -3.8, 
                duration: 2.5,
                ease: "power3.inOut",
                onComplete: () => {
                    roomGroup.visible = false;
                    mapGroup.visible = true;
                    appState = 'map';
                    camera.position.set(-15, 25, 25); 
                    camera.lookAt(0, 0, 0);
                }
            });
        }

        window.addEventListener('pointerdown', (e) => {
            if(appState !== 'book') return;
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(pages.map(p => p.mesh));
            if(intersects.length > 0) {
                let clickedPage = pages.find(p => p.mesh === intersects[0].object);
                if(clickedPage) clickedPage.mesh.userData.flipped = !clickedPage.mesh.userData.flipped;
            }
        });

        function animate() {
            requestAnimationFrame(animate);

            if (appState === 'map') {
                mapProgress += 0.0015; 
                if (mapProgress >= 1) {
                    mapProgress = 1;
                    if(mapGroup.visible) {
                         mapGroup.visible = false;
                         bookGroup.visible = true;
                         heartParticles.visible = true; 
                         
                         scene.background.setHex(0x2a0510);
                         
                         appState = 'book';
                         camera.position.set(0, 1, 6);
                         camera.lookAt(0, 0, 0);
                         document.getElementById('instructions').style.display = 'block';
                    }
                } else {
                    const currentPos = routeCurve.getPoint(mapProgress);
                    car.position.copy(currentPos);
                    car.lookAt(routeCurve.getPoint(Math.min(mapProgress + 0.01, 1)));
                }
            }

            if (appState === 'book') {
                const positions = heartParticles.geometry.attributes.position.array;
                for(let i=1; i < particleCount * 3; i+=3) {
                    positions[i] -= 0.02; 
                    if(positions[i] < -5) {
                        positions[i] = 15; 
                    }
                }
                heartParticles.geometry.attributes.position.needsUpdate = true;

                pages.forEach(p => {
                    const targetRot = p.mesh.userData.flipped ? -Math.PI * 0.95 : 0;
                    p.pivot.rotation.y += (targetRot - p.pivot.rotation.y) * 0.08;
                });
            }

            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
